import puppeteer from 'puppeteer';
import chromium from '@sparticuz/chromium';

export interface EstimateItem {
  id: string;
  description: string;
  quantity: number;
  unit: string;
  unit_price: number;
  line_total: number;
  arbetsmoment: string;
}

export interface LeadData {
  first_name: string;
  last_name: string;
  phone: string;
  email: string;
  full_address: string;
  street_address: string;
  postal_code: string;
  city: string;
}

export interface EstimateData {
  id: string;
  estimate_nr: number;
  status: string;
  created: string;
  valid_until: string;
  notes: string;
  total_amount: number;
  total_amount_vat: number;
  vat_amount: number;
  estimated_work_days: number;
  items: EstimateItem[];
  lead: LeadData | null;
}

/**
 * Generate HTML content for PDF from estimate data
 */
function generateHTMLContent(estimate: EstimateData): string {
  const formatCurrency = (amount: number) => {
    return new Intl.NumberFormat('sv-SE', {
      style: 'currency',
      currency: 'SEK',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0,
    }).format(amount);
  };

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('sv-SE');
  };

  // Function to clean category names by removing sort numbers
  const cleanCategoryName = (category: string): string => {
    // Remove pattern like "10 - ", "20 - ", "99 - " etc.
    return category.replace(/^\d+\s*-\s*/, '');
  };

  // Group items by arbetsmoment (work category)
  const groupedItems = estimate.items.reduce((groups, item) => {
    const category = cleanCategoryName(item.arbetsmoment || 'Ã–vriga arbeten');
    if (!groups[category]) {
      groups[category] = [];
    }
    groups[category].push(item);
    return groups;
  }, {} as Record<string, EstimateItem[]>);

  // Calculate totals by category
  const categoryTotals = Object.entries(groupedItems).map(([category, items]) => ({
    category,
    total: items.reduce((sum, item) => sum + item.line_total, 0),
    items
  }));

  const clientName = estimate.lead 
    ? `${estimate.lead.first_name} ${estimate.lead.last_name}`
    : 'Kund';

  const clientAddress = estimate.lead?.full_address || 'Adress';
  const clientPhone = estimate.lead?.phone || 'Telefon';
  const clientEmail = estimate.lead?.email || 'E-post';

  // Generate estimate table HTML
  const estimateTableHTML = categoryTotals.map(({ category, items, total }) => `
    <tr class="category-header">
      <td colspan="5">${category}</td>
    </tr>
    ${items.map(item => `
      <tr>
        <td>${item.description}</td>
        <td class="text-right">${item.quantity}</td>
        <td>${item.unit}</td>
        <td class="text-right">${formatCurrency(item.unit_price)}</td>
        <td class="text-right">${formatCurrency(item.line_total)}</td>
      </tr>
    `).join('')}
    <tr class="category-total">
      <td colspan="4"><strong>Summa ${category}</strong></td>
      <td class="text-right"><strong>${formatCurrency(total)}</strong></td>
    </tr>
  `).join('');

  // BKS Logo - use full URL for Puppeteer to load
  const baseUrl = process.env.NEXT_PUBLIC_SITE_URL || 'https://bks-calculator.vercel.app';
  // const bksLogoUrl = "data:image/png;base64,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

  return `
    <!DOCTYPE html>
    <html>
      <head>
        <meta charset="utf-8" />
        <title>BKS AB - Offert #${estimate.estimate_nr}</title>
        <style>
          * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
          }
          
          body {
            font-family: Arial, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            color: #333;
            max-width: 210mm;
            margin: 0 auto;
            padding: 20px;
            background: white;
          }
          
          .header-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
          }
          
          .header-table td {
            padding: 15px;
            border: 1px solid #ddd;
            vertical-align: top;
          }
          
          .header-table td:first-child {
            width: 50%;
          }
          
          h1 {
            color: #2c5530;
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
          }
          
          h2 {
            color: #2c5530;
            font-size: 18px;
            margin: 25px 0 15px 0;
            border-bottom: 2px solid #2c5530;
            padding-bottom: 5px;
          }
          
          h3 {
            color: #2c5530;
            font-size: 16px;
            margin: 20px 0 10px 0;
          }
          
          .estimate-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
          }
          
          .estimate-table th,
          .estimate-table td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
          }
          
          .estimate-table th {
            background-color: #f5f5f5;
            font-weight: bold;
          }
          
          .category-header {
            background-color: transparent;
            color: #333;
            font-weight: bold;
            font-size: 16px;
          }
          
          .category-total {
            background-color: #e5e5e5;
            font-weight: bold;
          }
          
          .final-totals {
            background-color: #e8f5e8;
            font-weight: bold;
          }
          
          .text-right {
            text-align: right;
          }
          
          .greeting {
            margin: 20px 0;
            font-size: 16px;
          }
          
          p {
            margin-bottom: 15px;
            text-align: justify;
          }
          
          ul, ol {
            margin: 15px 0;
            padding-left: 25px;
          }
          
          li {
            margin-bottom: 8px;
          }
          
          .contact-info {
            margin-top: 40px;
            padding: 20px;
            background-color: #f9f9f9;
            border-left: 4px solid #2c5530;
          }
          
          .page-break {
            page-break-before: always;
          }
          
          .signature-section {
            margin-top: 50px;
            text-align: center;
          }
          
          .logo-container {
            text-align: center;
            margin-bottom: 20px;
          }
          
          .logo {
            max-width: 120px;
            height: auto;
          }
        </style>
      </head>
      <body>        
        <h1>Vackra och hÃ¥llbara uteplatser</h1>
        
        <table class="header-table">
          <tr>
            <td>
              <strong>BestÃ¤llare:</strong><br />
              ${clientName}<br />
              ${clientAddress}<br />
              ${clientPhone}<br />
              ${clientEmail}
            </td>
            <td>
              <strong>EntreprenÃ¶r:</strong><br />
              BKS AB<br />
              Kungsgatan 29, 111 56 Stockholm<br />
              Org.nr: 559179-6700<br />
              0735757897<br />
              info@bksakeri.se<br />
              <br />
              FÃ¶retaget innehar F-skattsedel samt allrisk- och ansvarsfÃ¶rsÃ¤kring i Gjensidige FÃ¶rsÃ¤kring
            </td>
          </tr>
        </table>

        <div class="greeting">
          Hej ${estimate.lead?.first_name || 'Kund'},
        </div>

        <p><strong>VÃ¤lkommen till ditt nya stenprojekt med BKS AB!</strong></p>

        <p>I denna offert presenterar vi vÃ¥rt sÃ¤tt fÃ¶r att fÃ¶rverkliga din vision om en vacker och funktionell stenlagd uteplats. Baserat pÃ¥ vÃ¥rt inledande samtal och platsbesÃ¶k har vi skrÃ¤ddarsytt en lÃ¶sning som mÃ¶ter dina specifika Ã¶nskemÃ¥l och behov.</p>

        <p>HÃ¤r beskriver vi ingÃ¥ende vÃ¥r arbetsprocess, frÃ¥n noggrann planering och materialval till grundarbete och hantverksmÃ¤ssig stenlÃ¤ggning. Du fÃ¥r ocksÃ¥ en detaljerad specifikation av valda produkter, en transparent prisbild samt information om garantier.</p>

        <p>VÃ¥rt mÃ¥l Ã¤r att du ska kÃ¤nna dig trygg och vÃ¤linformerad genom hela processen. Vi hoppas att denna offert ger dig en tydlig bild av hur vi pÃ¥ BKS AB kan hjÃ¤lpa dig att skapa uteplatsen du drÃ¶mmer om. Tveka inte att hÃ¶ra av dig med frÃ¥gor!</p>

        <p><strong>LÃ¥t oss tillsammans ta fÃ¶rsta steget mot fÃ¶rverkligandet av ditt stenprojekt!</strong></p>

        <h2>Arbetsprocess - frÃ¥n idÃ© till fÃ¤rdigt resultat</h2>

        <h3>Detaljerad offert baserad pÃ¥ dina Ã¶nskemÃ¥l</h3>
        <p>Baserat pÃ¥ den kostnadsfria konsultationen och platsbesÃ¶ket, dÃ¤r vi lyssnade pÃ¥ dina tankar och Ã¶nskemÃ¥l samt inspekterade ytan, har vÃ¥ra experter tagit fram denna detaljerade offert. HÃ¤r presenterar vi vÃ¥ra rekommendationer kring lÃ¤mpliga material och designlÃ¶sningar, skrÃ¤ddarsydda fÃ¶r ditt projekt. Offerten har ett fastpris, sÃ¥ du slipper Ã¶verraskningar lÃ¤ngre fram.</p>

        <h3>Noggrann planering och materialval</h3>
        <p>NÃ¤r du accepterat offerten gÃ¥r vi vidare med noggrann planering. Vi stÃ¤mmer av dina val av plattor, fÃ¤rg och mÃ¶nster och bestÃ¤ller hem hÃ¶gkvalitativt material frÃ¥n vÃ¤lrenommerade leverantÃ¶rer. Allt fÃ¶r att fÃ¶rverkliga din vision.</p>

        <h3>Grundarbete med fokus pÃ¥ hÃ¥llbarhet</h3>
        <p>PÃ¥ utsatt datum bÃ¶rjar vÃ¥rt team arbetet. Beroende pÃ¥ ytans beskaffenhet och fÃ¶rutsÃ¤ttningar anpassar vi grundarbetet:</p>

        <p><strong>Scenario 1: Ytan Ã¤r fÃ¶rberedd fÃ¶r stenlÃ¤ggning</strong><br />
        Om ytan redan Ã¤r fÃ¶rberedd kontrollerar vi fÃ¶rst att lutningen Ã¤r korrekt fÃ¶r god vattenavrinning. Vid behov justerar vi fallet med hjÃ¤lp av laser och vattenpass. DÃ¤refter lÃ¤gger vi ut ett lager av stenflis eller stenmjÃ¶l som ytskikt, fÃ¶r optimal drÃ¤nering och bÃ¤righet.</p>

        <p><strong>Scenario 2: Ytan krÃ¤ver fullstÃ¤ndig preparation</strong><br />
        Om ytan dÃ¤remot inte Ã¤r fÃ¶rberedd, bÃ¶rjar vi med att grÃ¤va ut till rÃ¤tt djup. Detta gÃ¶rs fÃ¶r hand, med kranbil eller grÃ¤vmaskin, beroende pÃ¥ ytans storlek och Ã¥tkomlighet. Vi lÃ¤gger sedan en fiberduk som separerar underlaget och fÃ¶rhindrar ogrÃ¤s. OvanpÃ¥ detta fyller vi pÃ¥ med bergkross i lÃ¤mplig fraktion som bÃ¤rlager. Varje lager packas noggrant med vibroplatta fÃ¶r att skapa en stabil grund. Slutligen adderar vi ett ytskikt av stenflis, och pÃ¥ sÃ¥ sÃ¤tt fÃ¶rbereder vi fÃ¶r stenlÃ¤ggning.</p>

        <p>Oavsett utgÃ¥ngslÃ¤ge utfÃ¶r vi grundarbetet med omsorg och expertis. Vi anvÃ¤nder alltid Ã¤ndamÃ¥lsenlig utrustning och beprÃ¶vade metoder fÃ¶r att skapa bÃ¤sta mÃ¶jliga fÃ¶rutsÃ¤ttningar fÃ¶r din nya stenlÃ¤ggning. Detta grundarbete Ã¤r avgÃ¶rande fÃ¶r ett hÃ¥llbart och lÃ¥ngvarigt resultat.</p>

        <h3>StenlÃ¤ggning med kÃ¤nsla fÃ¶r detaljer</h3>
        <p>Med en stabil grund pÃ¥ plats Ã¤r det dags fÃ¶r vÃ¥ra hantverkare att lÃ¤gga stenarna enligt det Ã¶verenskomna mÃ¶nstret. Detta gÃ¶rs med stÃ¶rsta precision och kÃ¤nsla fÃ¶r detaljer. Stenar tilldelas och ytterkanterna anpassas genom kapning fÃ¶r ett prydligt intryck. Plattorna sÃ¤tts med distanser fÃ¶r jÃ¤mna fogar som sedan fylls med specialanpassat fogmaterial. Vi anvÃ¤nder moderna hjÃ¤lpmedel men traditionell hantverksskicklighet Ã¤r avgÃ¶rande fÃ¶r ett gediget slutresultat.</p>

        <h3>Avslutande finish och kvalitetskontroll</h3>
        <p>I slutfasen finputsar vi ytan genom att sopa rent och tvÃ¤tta bort eventuella fogrester. VÃ¥rt mÃ¥l Ã¤r att lÃ¤mna Ã¶ver en fin stenlÃ¤ggning som Ã¶vertrÃ¤ffar dina fÃ¶rvÃ¤ntningar. Som ett sista steg gÃ¶r vi en grundlig kvalitetsgenomgÃ¥ng tillsammans med dig som kund, fÃ¶r att sÃ¤kerstÃ¤lla att allt Ã¤r enligt Ã¶nskemÃ¥l.</p>

        <p>Genom hela processen, frÃ¥n offertfÃ¶rfrÃ¥gan till avslutad stenlÃ¤ggning, sÃ¤tter vi dina Ã¶nskemÃ¥l i centrum. Med gedigen erfarenhet, kvalitetsmaterial och beprÃ¶vade metoder ser vi till att leverera resultat som Ã¶vertrÃ¤ffar fÃ¶rvÃ¤ntningarna. LÃ¥t BKS AB fÃ¶rverkliga visionen om din nya uteplats!</p>

        <div class="page-break"></div>

        <h2>Arbetets omfattning med pris</h2>

        <table class="estimate-table">
          <thead>
            <tr>
              <th>Beskrivning</th>
              <th>Kvantitet</th>
              <th>Enhet</th>
              <th>Pris/enhet</th>
              <th class="text-right">Summa</th>
            </tr>
          </thead>
          <tbody>
            ${estimateTableHTML}
            <tr>
              <td colspan="5"></td>
            </tr>
            <tr class="final-totals">
              <td colspan="4"><strong>Summa exkl. moms</strong></td>
              <td class="text-right"><strong>${formatCurrency(estimate.total_amount)}</strong></td>
            </tr>
            <tr class="final-totals">
              <td colspan="4"><strong>Moms (25%)</strong></td>
              <td class="text-right"><strong>${formatCurrency(estimate.vat_amount)}</strong></td>
            </tr>
            <tr class="final-totals">
              <td colspan="4"><strong>Totalt inkl. moms</strong></td>
              <td class="text-right"><strong>${formatCurrency(estimate.total_amount_vat)}</strong></td>
            </tr>
          </tbody>
        </table>

        <p><strong>BerÃ¤knad arbetstid:</strong> ${estimate.estimated_work_days} arbetsdagar</p>
        <p><strong>Offerten gÃ¤ller till:</strong> ${formatDate(estimate.valid_until)}</p>

        <h2>Dokumentation och kommunikation under projektets gÃ¥ng</h2>

        <p>PÃ¥ BKS AB tror vi pÃ¥ vikten av Ã¶ppen kommunikation och transparens genom hela projektet. FrÃ¥n start till mÃ¥l Ã¤r du som kund involverad och informerad. Detta ger dig trygghet och insyn i hur arbetet fortskrider.</p>

        <p><strong>Innan projektstart:</strong></p>
        <ul>
          <li>Detaljerad offert med specifikationer och prisbild</li>
          <li>Tydlig tidplan</li>
          <li>Kontaktinformation till ansvarig projektledare</li>
        </ul>

        <p><strong>Under stenlÃ¤ggningen:</strong></p>
        <ul>
          <li>Regelbundna uppdateringar frÃ¥n projektledaren via telefon eller e-post</li>
          <li>Bilduppdateringar som visar arbetets framsteg, skickade till dig digitalt</li>
        </ul>

        <p><strong>Efter avslutat projekt:</strong></p>
        <ul>
          <li>Slutdokumentation med bilder pÃ¥ den fÃ¤rdiga stenlÃ¤ggningen</li>
          <li>SkÃ¶tselrÃ¥d och instruktioner fÃ¶r att bevara ytan i toppskick</li>
          <li>Garantibevis och information om vÃ¥r eftermarknadsservice</li>
        </ul>

        <p><strong>UtÃ¶ver detta dokumenterar vi Ã¤ven arbetet internt fÃ¶r kvalitetssÃ¤kring:</strong></p>

        <ul>
          <li>Dagliga checklistor fÃ¶r utfÃ¶rt arbete och anvÃ¤nda material</li>
          <li>Egenkontroller enligt branschstandard</li>
          <li>Fotodokumentation av kritiska moment, t.ex. grundarbete och avvattningslÃ¶sningar</li>
        </ul>

        <p>All denna dokumentation arkiveras digitalt och Ã¤r tillgÃ¤nglig fÃ¶r dig som kund Ã¤ven efter avslutat projekt. Du ska kÃ¤nna dig trygg i att arbetet Ã¤r utfÃ¶rt enligt konstens alla regler och att du har full insyn i processen.</p>

        <p>Vi vÃ¤rdesÃ¤tter kommunikation och Ã¤r alltid bara ett telefonsamtal bort om du har frÃ¥gor eller funderingar. Med BKS AB kan du kÃ¤nna dig trygg genom hela resan frÃ¥n idÃ© till fÃ¤rdig stenlÃ¤ggning. Transparens Ã¤r en av hÃ¶rnstenarna i vÃ¥r verksamhet.</p>

        <div class="page-break"></div>

        <h2>Ã–vriga bestÃ¤mmelser</h2>

        <h3>FÃ¶rberedelse:</h3>
        <p>FÃ¶r att sÃ¤kerstÃ¤lla en smidig start pÃ¥ ditt stenlÃ¤ggningsprojekt behÃ¶ver vi att du som kund ser till att arbetsytan Ã¤r fri frÃ¥n hinder. Detta innebÃ¤r att flytta mÃ¶bler, krukor eller andra fÃ¶remÃ¥l som kan stÃ¥ i vÃ¤gen. Vi behÃ¶ver ocksÃ¥ tillgÃ¥ng till el och vatten i nÃ¤rheten av arbetsomrÃ¥det. Om det finns sÃ¤rskilda Ã¶nskemÃ¥l eller fÃ¶rutsÃ¤ttningar att ta hÃ¤nsyn till, ber vi dig att informera oss om detta i god tid fÃ¶re projektstart.</p>

        <h3>Verktyg:</h3>
        <p>FÃ¶r att sÃ¤kerstÃ¤lla effektivitet och precision i vÃ¥rt arbete anvÃ¤nder vi specialanpassade verktyg och maskiner avsedda fÃ¶r stenlÃ¤ggning. Detta inkluderar plattlyft fÃ¶r ergonomisk hantering samt markvibrator och stampar fÃ¶r kompaktering av underlag. VÃ¥ra hantverkare har tillgÃ¥ng till den utrustning som krÃ¤vs fÃ¶r att utfÃ¶ra ett professionellt arbete och Ã¤r vÃ¤l fÃ¶rtrogen med dess anvÃ¤ndning.</p>

        <h3>Avfallshantering:</h3>
        <p>Vi pÃ¥ BKS AB strÃ¤var efter att minimera vÃ¥rt miljÃ¶avtryck och hanterar allt avfall frÃ¥n projektet pÃ¥ ett ansvarsfullt sÃ¤tt. Ã–verblivet material som plattor, bergkross och stenmjÃ¶l Ã¥teranvÃ¤nds i mÃ¥n av mÃ¶jlighet i framtida projekt. Annat avfall som plast, kartong och Ã¶vrigt byggmaterial sorteras och Ã¥tervinns enligt gÃ¤llande miljÃ¶fÃ¶reskrifter. Som kund behÃ¶ver du inte oroa dig fÃ¶r bortforsling av avfall dÃ¥ detta ingÃ¥r i vÃ¥rt Ã¥tagande.</p>

        <h3>ArbetsmiljÃ¶:</h3>
        <p>SÃ¤kerhet och trivsel pÃ¥ arbetsplatsen Ã¤r viktigt fÃ¶r oss. VÃ¥ra hantverkare fÃ¶ljer gÃ¤llande arbetsmiljÃ¶regler och anvÃ¤nder fÃ¶reskriven skyddsutrustning som hjÃ¤lm, skyddsglasÃ¶gon och handskar. Vi tillÃ¤mpar ergonomiska arbetsmetoder fÃ¶r att minimera risken fÃ¶r fÃ¶rslitningsskador. Regelbundna arbetsplatstrÃ¤ffar hÃ¥lls fÃ¶r att diskutera sÃ¤kerhet och komma med fÃ¶rbÃ¤ttringsfÃ¶rslag. Vi tror pÃ¥ en Ã¶ppen dialog och uppmuntrar bÃ¥de personal och kunder att pÃ¥tala eventuella brister.</p>

        <h3>Transporter och lyft:</h3>
        <p>Allt material som krÃ¤vs fÃ¶r ditt stenlÃ¤ggningsprojekt, inklusive plattor, bÃ¤rlager och fogsand, transporteras till arbetsplatsen med fÃ¶retagets egna fordon. VÃ¥ra fordon Ã¤r anpassade fÃ¶r Ã¤ndamÃ¥let och uppfÃ¼ller gÃ¤llande sÃ¤kerhets- och utslÃ¤ppskrav. Vid lossning anvÃ¤nder vi kran eller truck beroende pÃ¥ fÃ¶rutsÃ¤ttningarna pÃ¥ plats. Lyft och fÃ¶rflyttning av tunga material sker med stÃ¶rsta fÃ¶rsiktighet fÃ¶r att undvika skador.</p>

        <h3>FÃ¶rsÃ¤kring:</h3>
        <p>BKS AB har en heltÃ¤ckande ansvarsfÃ¶rsÃ¤kring hos Gjensidige FÃ¶rsÃ¤kring som skyddar bÃ¥de oss och dig som kund vid eventuella skador eller olyckor i samband med vÃ¥rt arbete. FÃ¶rsÃ¤kringen gÃ¤ller fÃ¶r skador pÃ¥ personer, egendom och utfÃ¶rt arbete och ger dig som kund ett extra skydd vid ofÃ¶rutsedda hÃ¤ndelser.</p>

        <h2>Hantering av ofÃ¶rutsedda problem eller hinder</h2>

        <p>Trots noggrann planering kan ofÃ¶rutsedda situationer uppstÃ¥ under arbetets gÃ¥ng, t.ex:</p>
        <ul>
          <li>UpptÃ¤ckt av sÃ¤ttningsskador eller andra problem med underlaget</li>
          <li>Extrema vÃ¤derfÃ¶rhÃ¥llanden som fÃ¶rsenas eller hindrar arbetet</li>
          <li>FÃ¶rseningar i materialleveranser frÃ¥n tredje part</li>
        </ul>

        <p>Om sÃ¥dana omstÃ¤ndigheter intrÃ¤ffar kommer vi omgÃ¥ende att kommunicera detta till dig som kund. Tillsammans finner vi den bÃ¤sta lÃ¶sningen fÃ¶r att komma vidare i projektet pÃ¥ ett smidigt sÃ¤tt. Eventuella merkostnader till fÃ¶ljd av ofÃ¶rutsedda hinder hanteras som tillÃ¤ggsarbete efter godkÃ¤nnande frÃ¥n dig.</p>

        <h2>Ã„ndringar och tillÃ¤ggsarbeten</h2>

        <p>Vi strÃ¤var alltid efter att uppfylla dina Ã¶nskemÃ¥l och Ã¤r flexibla fÃ¶r Ã¤ndringar under projektets gÃ¥ng. Om du kommer pÃ¥ nya idÃ©er eller vill gÃ¶ra tillÃ¤gg utÃ¶ver grundofferten har vi rutiner fÃ¶r att hantera detta:</p>
        <ul>
          <li>Meddela Ã¶nskemÃ¥len till ansvarig projektledare.</li>
          <li>Vi tar fram en specifikation och prissÃ¤ttning fÃ¶r tillÃ¤ggsarbetet.</li>
          <li>Efter ditt godkÃ¤nnande planerar vi in arbetet pÃ¥ lÃ¤mpligaste sÃ¤tt.</li>
          <li>TillÃ¤ggsarbetet faktureras separat efter utfÃ¶rande.</li>
        </ul>

        <p>Genom att ha en tydlig och transparent hantering av vad som ingÃ¥r och inte ingÃ¥r i offerten, samt hur vi hanterar avvikelser, skapar vi trygghet fÃ¶r dig som kund. Du ska veta vad du kan fÃ¶rvÃ¤nta dig och inte behÃ¶va oroa dig fÃ¶r dolda kostnader.</p>

        <h2>Referenser</h2>

        <p>VÃ¥ra tidigare kunder Ã¤r de bÃ¤sta ambassadÃ¶rerna fÃ¶r vÃ¥rt arbete. De har upplevt vÃ¥r stenlÃ¤ggningsprocess frÃ¥n start till mÃ¥l och kan ge dig en Ã¤rlig inblick i hur det Ã¤r att samarbeta med oss. Genom att hÃ¶ra deras berÃ¤ttelser fÃ¥r du en god uppfattning om vÃ¥r kompetens, service och kvalitet.</p>

        <p>Tveka inte att kontakta nÃ¥gra av vÃ¥ra tidigare kunder fÃ¶r att hÃ¶ra deras omdÃ¶men. De kan ge dig vÃ¤rdefulla insikter och svar pÃ¥ frÃ¥gor du kanske har infÃ¶r ditt eget stenprojekt. Att hÃ¶ra nÃ¥gon annans positiva upplevelse kan ge extra trygghet nÃ¤r du fattar ditt beslut.</p>

        <p>Nedan finner du kontaktuppgifter till ett urval av vÃ¥ra tidigare kunder. KÃ¤nn dig fri att kontakta dem!</p>

        <ol>
          <li><strong>Abbe</strong> - Bygg och MiljÃ¶ - 0737280744</li>
          <li><strong>Rajaa</strong> - SÃ¶derby - 0737768162</li>
          <li><strong>Hadil</strong> - Uppsala - 0760062967</li>
          <li><strong>Maria</strong> - Farsta - 0737868856</li>
          <li><strong>Razvan</strong> - Asielbygg - 07320550031</li>
        </ol>

        <h2>Betalning</h2>

        <p><strong>Fakturering:</strong><br />
        Vi tillÃ¤mpar fÃ¶ljande faktureringsprocess fÃ¶r att gÃ¶ra det smidigt fÃ¶r dig som kund:</p>
        <ul>
          <li>30% av totalsumman faktureras vid projektstart och betalas innan arbetet pÃ¥bÃ¶rjas.</li>
          <li>30% faktureras nÃ¤r grundarbetet Ã¤r slutfÃ¶rt och betalas inom 10 dagar.</li>
          <li>Resterande 40% faktureras vid godkÃ¤nd slutbesiktning och betalas inom 10 dagar.</li>
        </ul>

        <p>Eventuella tillÃ¤ggsarbeten faktureras separat efter utfÃ¶rande med 10 dagars betalningstid.</p>

        <h3>Betalningsvillkor:</h3>
        <ul>
          <li>Fakturor betalas inom 10 dagar frÃ¥n fakturadatum.</li>
          <li>Vid fÃ¶rsenad betalning utgÃ¥r drÃ¶jsmÃ¥lsrÃ¤nta enligt gÃ¤llande referensrÃ¤nta + 8%.</li>
          <li>BKS AB fÃ¶rbehÃ¥ller sig Ã¤ganderÃ¤tten av allt material tills full betalning erlagts.</li>
        </ul>

        <h2>Garanti</h2>

        <p><strong>Garantitid:</strong></p>
        <ul>
          <li>PÃ¥ utfÃ¶rt arbete lÃ¤mnar vi 2 Ã¥rs garanti.</li>
          <li>PÃ¥ material gÃ¤ller respektive tillverkares garantier, generellt 2-5 Ã¥r.</li>
        </ul>

        <p><strong>Garantivillkor:</strong></p>
        <ul>
          <li>Garantin omfattar arbetsutfÃ¶rande och materialkvalitet enligt branschstandard.</li>
          <li>Undantag frÃ¥n garantin Ã¤r skador orsakade av yttre pÃ¥verkan, bristande underhÃ¥ll, onormalt slitage eller Ã¤ndringar utfÃ¶rda av tredje part.</li>
          <li>FÃ¶r att garantin ska gÃ¤lla skall skÃ¶tselinstruktioner fÃ¶ljas.</li>
        </ul>

        <h2>FÃ¶rsÃ¤kring</h2>

        <p>BKS AB har en ansvarsfÃ¶rsÃ¤kring hos Gjensidige FÃ¶rsÃ¤kring som tÃ¤cker eventuella skador orsakade av vÃ¥rt arbete upp till 10 Mkr. Vi Ã¤r ocksÃ¥ fullt fÃ¶rsÃ¤krade om olyckor och skador pÃ¥ vÃ¥r egen personal och utrustning. Du Ã¤r trygg med oss!</p>

        <h2>Vi friskriver oss frÃ¥n</h2>

        <p><strong>Berg som kan fÃ¶rekomma vid grÃ¤vning:</strong> GÃ¥r det inte att grÃ¤va ner till den nivÃ¥ som vi behÃ¶ver pÃ¥ grund av att vi hittar berg sÃ¥ blir det en extra kostnad fÃ¶r det jobbet.</p>

        <p><strong>Ledningar:</strong> Du som kund Ã¤r ansvarig fÃ¶r att visa var ledningar som Ã¤r nedgrÃ¤vda finns. GrÃ¤ver vi bort nÃ¥got som inte har visats fÃ¶r oss kommer vi inte kunna Ã¥terstÃ¤lla det utan kostnad.</p>

        <p><strong>FÃ¶roreningar i mark:</strong> Skulle det vara sÃ¥ att tippen gÃ¶r ett stickprov pÃ¥ schaktmassorna och visar det att det Ã¤r fÃ¶rorenat kommer vi att debitera extra fÃ¶r det.</p>

        <h2>NÃ¤sta steg</h2>

        <p>FÃ¶r att boka tjÃ¤nsten och komma igÃ¥ng med ditt stenprojekt gÃ¶r du sÃ¥ hÃ¤r:</p>
        <ul>
          <li>Acceptera offerten genom att svara pÃ¥ e-post eller ringa oss direkt.</li>
          <li>VÃ¤lj Ã¶nskat startdatum fÃ¶r projektet i samrÃ¥d med vÃ¥r projektledare.</li>
          <li>Projektering och materialleverans planeras in utifrÃ¥n Ã¶nskat startdatum.</li>
          <li>Underteckna och returnera HantverkarformulÃ¤ret som vÃ¥rt kontrakt innan projektstart.</li>
          <li>Vi ses pÃ¥ plats fÃ¶r uppstartsgenomgÃ¥ng pÃ¥ utsatt datum!</li>
        </ul>

        <p>Denna offert Ã¤r giltig i 30 dagar frÃ¥n dagens datum. Tveka inte att hÃ¶ra av dig om du har nÃ¥gra frÃ¥gor!</p>

        <div class="contact-info">
          <p><strong>Kontaktperson:</strong><br />
          Ramiro Botero, projektledare<br />
          Tel: 073 575 78 97<br />
          E-post: info@bksakeri.se<br />
          https://www.bksakeri.se</p>

          <div class="signature-section">
            <p>Vi ser fram emot att fÃ¶rverkliga ditt stenprojekt!</p>
            <p><strong>Med vÃ¤nliga hÃ¤lsningar,<br />
            Teamet pÃ¥ BKS AB</strong></p>
          </div>
        </div>
      </body>
    </html>
  `;
}

/**
 * Generate PDF from estimate data using Puppeteer
 */
export async function generateEstimatePDF(estimate: EstimateData): Promise<Buffer> {
  let browser;
  
  try {
    // Configure for Vercel serverless environment
    const isProduction = process.env.NODE_ENV === 'production';
    console.log('PDF Generation environment:', { isProduction, nodeEnv: process.env.NODE_ENV });
    
    if (isProduction) {
      // Use @sparticuz/chromium for Vercel deployment
      console.log('Using @sparticuz/chromium for production');
      browser = await puppeteer.launch({
        args: [
          ...chromium.args,
          '--hide-scrollbars',
          '--disable-web-security',
          '--disable-features=VizDisplayCompositor',
        ],
        executablePath: await chromium.executablePath(),
        headless: true,
      });
    } else {
      // Local development
      browser = await puppeteer.launch({
        headless: true,
        args: [
          '--no-sandbox',
          '--disable-setuid-sandbox',
          '--disable-dev-shm-usage',
          '--disable-accelerated-2d-canvas',
          '--no-first-run',
          '--no-zygote',
          '--disable-gpu'
        ]
      });
    }

    const page = await browser.newPage();

    // Set longer timeout for image loading
    page.setDefaultTimeout(30000);
    page.setDefaultNavigationTimeout(30000);

    // Generate HTML content
    const htmlContent = generateHTMLContent(estimate);

    // Set page content and wait for all resources to load
    await page.setContent(htmlContent, {
      waitUntil: 'networkidle0',
      timeout: 30000
    });

    // Wait a bit more for images to load
    await new Promise(resolve => setTimeout(resolve, 2000));

    console.log('Page content set, generating PDF...');

    // Generate PDF with options
    const pdfBuffer = await page.pdf({
      format: 'A4',
      printBackground: true,
      margin: {
        top: '20mm',
        right: '15mm',
        bottom: '20mm',
        left: '15mm'
      },
      displayHeaderFooter: true,
      headerTemplate: `
        <div style="font-size: 10px; text-align: center; width: 100%; color: #666;">
          <span>BKS AB - Offert #${estimate.estimate_nr}</span>
        </div>
      `,
      footerTemplate: `
        <div style="font-size: 10px; text-align: center; width: 100%; color: #666;">
          <span>Sida <span class="pageNumber"></span> av <span class="totalPages"></span></span>
        </div>
      `,
      preferCSSPageSize: false
    });

    return Buffer.from(pdfBuffer);

  } catch (error) {
    console.error('Error generating PDF:', error);
    throw new Error('Failed to generate PDF');
  } finally {
    if (browser) {
      await browser.close();
    }
  }
}

/**
 * Generate filename for the PDF
 */
export function generatePDFFilename(estimate: EstimateData): string {
  const clientName = estimate.lead 
    ? `${estimate.lead.first_name}_${estimate.lead.last_name}`.replace(/\s+/g, '_')
    : 'kund';
  
  const date = new Date().toISOString().split('T')[0];
  
  return `BKS_Offert_${estimate.estimate_nr}_${clientName}_${date}.pdf`;
}